<!doctype html>
<html lang="om">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Oromo Syllabifier</title>

<style>
  body{
    margin:0;
    padding:20px 12px;
    font-family:Inter, system-ui, Roboto, Arial;
    background:#f0f2ff;
    display:flex;
    justify-content:center;
  }

  .card{
    width:100%;
    max-width:520px;
    background:white;
    padding:22px;
    border-radius:16px;
    box-shadow:0 3px 14px rgba(0,0,0,0.05);
    border:1px solid #e6e8f5;
  }

  h1{
    margin:0 0 20px;
    font-size:22px;
    font-weight:700;
    text-align:center;
    color:#1a1d33;
  }

  input{
    width:100%;
    padding:16px;
    border-radius:12px;
    border:1.6px solid #d7dbeb;
    font-size:18px;
    outline:none;
    background:#fafbff;
  }
  input:focus{
    border-color:#3a49ff;
    box-shadow:0 0 0 3px rgba(85,102,255,0.18);
  }

  .row{
    display:flex;
    gap:12px;
    margin-top:18px;
  }

  button{
    flex:1;
    padding:14px 0;
    font-size:17px;
    font-weight:600;
    border-radius:12px;
    border:1.6px solid #dadffe;
    cursor:pointer;
    background:#f3f5ff;
    color:#20233f;
  }

  #go{
    background:#3e4aff;
    border-color:#3e4aff;
    color:white;
  }

  pre{
    background:#0c1124;
    color:#e9eeff;
    padding:16px;
    border-radius:12px;
    margin-top:18px;
    font-size:17px;
    white-space:pre-wrap;
  }

  /* Hide result area & Saga2 as ordered */
  #result { display:none; }
  #saga2  { display:none; }

  /* NEW visible result area */
  #newResult{
    background:#eef2ff;
    color:#1a1d33;
    padding:16px;
    border-radius:12px;
    margin-top:18px;
    border:1px solid #d9ddff;
    font-size:17px;
    white-space:pre-wrap;
  }
</style>
</head>

<body>
<div class="card">

    <h1>Oromo Syllabifier</h1>

    <input id="word" placeholder="Jecha galchi...">

    <div class="row">
        <button id="go">Split</button>
        <button id="clear">Clear</button>
    </div>

    <!-- NEW RESULT -->
    <pre id="newResult"></pre>

    <!-- Hidden -->
    <pre id="result"></pre>

    <!-- Syllable steps -->
    <pre id="saga1"></pre>
    <pre id="saga2"></pre>
    <pre id="saga3"></pre>
    <pre id="count"></pre>

    <button onclick="playSaga3Audio()" 
style="width:100%;margin-top:12px;padding:14px;border-radius:12px;
background:#0a7cff;color:white;font-size:17px;font-weight:600;">
ðŸ”Š Play TTS Audio Syllables
</button>

</div>

<!-- SYLLABIFIER FULL LOGIC (unchanged) -->
<script>
(() => {

  const dcMap = {
    "ch":"Ã‡","dh":"Ã","ny":"Ã‘",
    "ph":"Ãž","ts":"Å¦","sh":"Å ","zy":"Å½"
  };
  const APOST = "Æµ";
  const revMap = Object.fromEntries(Object.entries(dcMap).map(([k,v])=>[v,k]));

  function normalize(w){
    let s = w.toLowerCase();
    for(const k of Object.keys(dcMap)) s = s.split(k).join(dcMap[k]);
    return s.replace(/'/g, APOST);
  }

  function unNormalizePiece(p){
    let s = p;
    for(const [v,k] of Object.entries(revMap)) s = s.split(v).join(k);
    s = s.split(APOST).join("'");
    return s;
  }

  const placeholders = Object.values(dcMap).join('') + APOST;
  const isV = ch => ch && "aeiou".includes(ch);
  const isC = ch =>
     ch &&
     (placeholders.includes(ch)
      || ch === 'y'
      || ch === '.'
      || ch === '?'
      || ch === '!'
      || ch === ','
      || ch === '"'
      || ch === ';'
      || ch === ':'
      || (/^[a-z]$/i.test(ch) && !"aeiou".includes(ch)));

  function fixSpaceVowelRule(text){
      return text.replace(/ ([aeiou])/gi, " '$1");
  }

  function extractEnd(norm){
    const L = norm.length;
    const s=i=>norm[i]||"";
    if(L>=5){
      const [c1,c2,v1,v2,c3]=[s(L-5),s(L-4),s(L-3),s(L-2),s(L-1)];
      if(isC(c1)&&isC(c2)&&isV(v1)&&isV(v2)&&isC(c3)&&c1!==c2) return norm.slice(L-4);
    }
    if(L>=4){
      const [c1,c2,v,c3]=[s(L-4),s(L-3),s(L-2),s(L-1)];
      if(isC(c1)&&isC(c2)&&isV(v)&&isC(c3)&&c1!==c2) return norm.slice(L-3);
    }
    if(L>=4){
      const [c1,c2,v1,v2]=[s(L-4),s(L-3),s(L-2),s(L-1)];
      if(isC(c1)&&isC(c2)&&isV(v1)&&isV(v2)&&c1!==c2) return norm.slice(L-3);
    }
    if(L>=3){
      const [cprev,c,v]=[s(L-3),s(L-2),s(L-1)];
      if(isC(cprev)&&isC(c)&&isV(v)&&cprev!==c) return norm.slice(L-2);
    }
    if(L>=5){
      const [a,b,c,d,e]=[s(L-5),s(L-4),s(L-3),s(L-2),s(L-1)];
      if(isC(a)&&isC(b)&&isV(c)&&isV(d)&&isC(e)) return norm.slice(L-5);
    }
    if(L>=4){
      const [a,b,c,d]=[s(L-4),s(L-3),s(L-2),s(L-1)];
      if(isC(a)&&isC(b)&&isV(c)&&isC(d)) return norm.slice(L-4);
    }
    if(L>=4){
      const [a,b,c,d]=[s(L-4),s(L-3),s(L-2),s(L-1)];
      if(isC(a)&&isV(b)&&isV(c)&&isC(d)) return norm.slice(L-4);
    }
    if(L>=3){
      const [a,b,c]=[s(L-3),s(L-2),s(L-1)];
      if(isC(a)&&isV(b)&&isC(c)) return norm.slice(L-3);
    }
    if(L>=4){
      const [a,b,c,d]=[s(L-4),s(L-3),s(L-2),s(L-1)];
      if(isC(a)&&isC(b)&&isV(c)&&isV(d)) return norm.slice(L-4);
    }
    if(L>=3){
      const [a,b,c]=[s(L-3),s(L-2),s(L-1)];
      if(isC(a)&&isC(b)&&isV(c)) return norm.slice(L-3);
    }
    if(L>=3){
      const [a,b,c]=[s(L-3),s(L-2),s(L-1)];
      if(isC(a)&&isV(b)&&isV(c)) return norm.slice(L-3);
    }
    if(L>=2){
      const [a,b]=[s(L-2),s(L-1)];
      if(isC(a)&&isV(b)) return norm.slice(L-2);
    }
    return norm.slice(-1);
  }

  function backwardSegments(norm){
    const pieces=[];
    while(norm.length>0){
      const end=extractEnd(norm);
      pieces.push(end);
      norm=norm.slice(0,norm.length-end.length);
    }
    return pieces;
  }

  function applyStartVowelRule(original){
    if(!original) return original;
    return "aeiou".includes(original[0].toLowerCase()) ? "'" + original : original;
  }

  function splitAndDisplay(word){
    const withStart = applyStartVowelRule(word);
    const norm = normalize(withStart.trim());
    const parts = backwardSegments(norm).reverse();
    return parts.map(unNormalizePiece).join("-");
  }

  function syllableCountFromSaga1(clean){
      if(!clean.trim()) return 0;
      let hy = (clean.match(/-/g) || []).length;
      return hy + 1;
  }

  function saga2Transform(clean){
    return clean.replace(/-/g,"--");
  }

  function saga3Transform(text){
    const cons = "(ch|dh|ny|ph|sh|ts|zy|[bcdfghjklmnpqrstvwxz]|y|\\.|')";
    const pattern = new RegExp("([aeiou])--" + cons, "gi");
    let result = text.replace(pattern, (m, v, C) => v + "-" + v + C + "-" + C);

    result = result.replace(
      /(ch|dh|ny|ph|sh|ts|zy|[bcdfghjklmnpqrstvwxz])--(ch|dh|ny|ph|sh|ts|zy|[bcdfghjklmnpqrstvwxz])/gi,
      "$1-$2"
    );

    result = result.replace(/--([.,!?;:"])/g, "$1");
    result = result.replace(/([.,!?;:"])--/g, "$1 ");

    return result;
  }

  function displayUnnormalize(text){
    if(!text) return text;
    let out = text;
    for(const [placeholder, digraph] of Object.entries(revMap)){
      out = out.split(placeholder).join(digraph);
    }
    out = out.split(APOST).join("'");
    return out;
  }

  const inp=document.getElementById("word");
  const out=document.getElementById("result");
  const s1=document.getElementById("saga1");
  const s2=document.getElementById("saga2");
  const s3=document.getElementById("saga3");
  const cnt=document.getElementById("count");
  const newRes=document.getElementById("newResult");

  document.getElementById("go").addEventListener("click",()=>{
    const raw = inp.value.trim();

    newRes.textContent = raw.toLowerCase();

    const fixed = fixSpaceVowelRule(raw);
    const outStr = splitAndDisplay(fixed);

    out.textContent = displayUnnormalize(outStr);

    let clean = outStr.replace(/\s+/g,"")
                      .replace(/--+/g,"-")
                      .replace(/^-+/, "")
                      .replace(/-+$/, "");

    s1.textContent = displayUnnormalize(clean);
    const s2v = saga2Transform(clean);
    s2.textContent = displayUnnormalize(s2v);
    s3.textContent = displayUnnormalize(saga3Transform(s2v));

    cnt.textContent = syllableCountFromSaga1(clean);
  });

  document.getElementById("clear").addEventListener("click",()=>{
    inp.value="";
    newRes.textContent="";
    out.textContent="";
    s1.textContent="";
    s2.textContent="";
    s3.textContent="";
    cnt.textContent="";
    inp.focus();
  });

  inp.addEventListener("keydown",e=>{
    if(e.key==="Enter"){
      e.preventDefault();
      document.getElementById("go").click();
    }
  });

})();
</script>

<!-- NEW AUDIO ENGINE -->
<script>
const AUDIO_BASE = "sagalee/";
let audioQueue = [];
let isAudioPlaying = false;

/* Clean syllabus â†’ filename */
function normalizeToken(t) {
    if (!t) return "";
    t = t.trim();

    // remove hyphens from tokens like -laa-, --ba-- etc
    t = t.replace(/^-+/, "").replace(/-+$/, "");
    t = t.replace(/-/g, "");

    // apostrophe token (start-vowel rule)
    if (t === "'") return "apostrophe";    // apostrophe.ogg  

    return t;
}

/* Play next audio file in queue */
function playNext() {
    if (audioQueue.length === 0) {
        isAudioPlaying = false;
        return;
    }

    isAudioPlaying = true;

    const raw = audioQueue.shift();
    const token = normalizeToken(raw);
    if (!token) {
        playNext();
        return;
    }

    const file = AUDIO_BASE + token + ".ogg";
    const audio = new Audio(file);

    audio.onerror = () => {
        console.warn("Missing audio file:", file);
        playNext();
    };

    audio.onended = () => playNext();

    audio.play().catch(() => playNext());
}

/* PUBLIC FUNCTION: play audio from Saga3 result */
function playSaga3Audio() {
    const saga1 = document.getElementById("saga1").textContent.trim();
    if (!saga1) return;

    // Example: ba-laa-la â†’ ["ba","laa","la"]
    audioQueue = saga1.split("-").filter(x => x.trim() !== "");

    if (!isAudioPlaying) playNext();
}
</script>

</body>
</html>